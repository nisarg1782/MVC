<?php
$this->getChildHtml("toolbar");
$columns = $this->getColumns();
?>

<button>
    <a href="<?php echo $this->getUrl("*/*/export") ?>">Export Data</a>
</button>
<br><br>

<?php if (in_array("product_id", array_keys($columns))): ?>
    <button>
        <a href="<?php echo $this->getUrl("*/*/new") ?>">Click to add new Product</a>
    </button>
<?php endif; ?>

<table border="1" id="dataTable">
    <thead>
        <tr>
            <?php foreach ($columns as $col): ?>
                <th><?php echo $col["label"]; ?></th>
            <?php endforeach; ?>
        </tr>
    </thead>
    <tbody>
        <!-- Filter Inputs Row -->
        <tr class="filter-row">
            <?php foreach ($columns as $col): ?>
                <td>
                    <?php if (isset($col["type"]) && $col["type"] == "number"): ?>
                        <input type="number" class="filter-input" name="<?php echo $col["label"]; ?>_min" placeholder="Min">
                        <input type="number" class="filter-input" name="<?php echo $col["label"]; ?>_max" placeholder="Max">
                    <?php else: ?>
                        <?php $this->renderFilter($col["label"]); ?>
                    <?php endif; ?>
                </td>
            <?php endforeach; ?>
        </tr>

        <!-- Data Rows -->
        <?php foreach ($this->getCollection()->getData() as $collection): ?>
            <tr class="data-row">
                <?php foreach ($columns as $col): ?>
                    <td data-filter-key="<?php echo $col['label']; ?>">
                        <?php echo $this->getValue($collection, $col); ?>
                    </td>
                <?php endforeach; ?>
            </tr>
        <?php endforeach; ?>
    </tbody>
</table>

<?php if (in_array("product_id", array_keys($columns))): ?>
    <a href="<?php echo $this->getUrl("admin/order/list") ?>">View Orders</a>
<?php endif; ?>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    function applyFilters() {
      const filters = document.querySelectorAll('.filter-row input, .filter-row select');
      let filterData = {};

      filters.forEach(input => {
        let key = input.name;
        let value = input.type === "checkbox" || input.type === "radio" ? input.checked : input.value.trim().toLowerCase();

        if (value !== "" && key) {
          filterData[key] = value;
        }
      });

      filterTable(filterData);
    }

    function filterTable(filters) {
      const rows = document.querySelectorAll(".data-row");

      rows.forEach(row => {
        let showRow = true;

        Object.keys(filters).forEach(filterKey => {
          const filterValue = filters[filterKey];
          let isMinFilter = filterKey.endsWith("_min");
          let isMaxFilter = filterKey.endsWith("_max");
          let baseKey = filterKey.replace("_min", "").replace("_max", "");
          let cell = row.querySelector(`[data-filter-key="${baseKey}"]`);

          if (cell) {
            let cellValue = parseFloat(cell.textContent.trim()) || 0;

            if (isMinFilter && cellValue < parseFloat(filterValue)) {
              showRow = false;
            }
            if (isMaxFilter && cellValue > parseFloat(filterValue)) {
              showRow = false;
            }
            if (!isMinFilter && !isMaxFilter) {
              let cellText = cell.textContent.trim().toLowerCase();
              if (!cellText.includes(filterValue)) {
                showRow = false;
              }
            }
          }
        });

        row.style.display = showRow ? "" : "none";
      });
    }

    // Attach event listeners to all filter inputs
    document.querySelectorAll('.filter-row input, .filter-row select').forEach(input => {
      input.addEventListener("input", applyFilters);
      input.addEventListener("change", applyFilters);
    });
  });
</script>
